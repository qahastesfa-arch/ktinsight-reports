<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EOTC Incident Reports - Recent</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#1a1a1a; --panel:#2b2b2b; --text:#f5f5f5; --muted:#e0e0e0;
      --gold:#f0d68a; --red:#8c1111; --stroke:#555; --link:#9ecbff;
    }
    body{
      font-family: Inter, "Noto Sans Ethiopic", Arial, sans-serif;
      background: var(--bg); color: var(--text); margin:0;
    }
    header{
      text-align:center;
      background: linear-gradient(180deg,#4b0000 0%,#2a0000 100%);
      padding:24px 16px;
      border-bottom:2px solid var(--red);
      position: relative;
    }

    img.logo{
      max-width:320px; height:auto; margin:8px 0 12px;
      filter: grayscale(20%) contrast(120%);
    }
    h1{ color:var(--gold); margin:8px 0 4px; }

    main{
      max-width:900px; margin:30px auto 40px; padding:0 16px 24px;
    }
    .intro{
      max-width:760px; margin:0 auto 16px; color:var(--muted);
      text-align:center; line-height:1.6;
    }

    /* ✅ Featured video highlight */
    .video-feature{
      max-width: 760px;
      margin: 18px auto 26px;
      border: 1px solid #333;
      border-radius: 12px;
      overflow: hidden;
      background:#000;
      box-shadow: 0 0 16px rgba(0,0,0,.6);
    }
    .video-feature iframe{
      width: 100%;
      aspect-ratio: 16 / 9;
      height: auto;
      display:block;
    }
    .video-caption{
      padding: 8px 10px;
      font-size: .9rem;
      color: #ccc;
      background: #151515;
      text-align: center;
      border-top: 1px solid #333;
    }

    .status{ text-align:center; margin:16px auto; font-size:.95rem; color:#ccc; }

    .list{ margin-top:10px; display:flex; flex-direction:column; gap:12px; }

    .card{
      background:var(--panel); border-radius:10px; border:1px solid #333;
      padding:14px 16px; box-shadow:0 0 12px rgba(0,0,0,.4);
    }
    .card-header{
      display:flex; flex-wrap:wrap; gap:8px 16px; align-items:baseline; margin-bottom:6px;
    }
    .card-date{ font-weight:600; color:var(--gold); font-size:.98rem; }
    .card-location{ font-size:.95rem; color:var(--muted); }

    /* ✅ Summary clamp to 3 lines */
    .card-summary{
      margin-top:4px; font-size:.97rem; line-height:1.55; white-space:pre-wrap;
    }
    .card-summary a{
      color:var(--link); text-decoration:underline; text-underline-offset:2px; word-break:break-all;
    }
    .summary-collapsed{
      display: -webkit-box;
      -webkit-line-clamp: 3;          /* ✅ show only 3 lines */
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .see-more{
      margin-top:6px;
      font-size:.9rem;
      color: var(--link);
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 2px;
      display: none; /* auto-enabled only if needed */
      width: fit-content;
    }

    .card-contact{ margin-top:8px; font-size:.88rem; color:#aaa; }
    .card-contact strong{ color:#ddd; }

    .evidence-wrap{ margin-top:10px; display:flex; flex-direction:column; gap:6px; }
    .evidence-label{ font-size:.85rem; color:#bbb; font-weight:600; }
    .evidence-img{
      width:100%; max-width:420px; border-radius:8px; border:1px solid #444; cursor:pointer;
      transition:transform .15s ease, border .15s ease;
    }
    .evidence-img:hover{ transform:scale(1.01); border-color:#777; }

    .evidence-link{
      font-size:.85rem; color:var(--link); word-break:break-all;
    }
    .evidence-link a{
      color:var(--link); text-decoration:underline; text-underline-offset:2px;
    }

    .evidence-note{
      display:none; font-size:.8rem; color:#bdbdbd; margin-top:4px;
    }
    .evidence-note.show{ display:block; }
    .evidence-note a{
      color:var(--link); text-decoration:underline; text-underline-offset:2px;
    }

    .evidence-help{
      font-size:.8rem; color:#bbb; cursor:pointer;
      text-decoration:underline; text-underline-offset:2px; width:fit-content;
    }

    footer{ text-align:center; margin:20px 0; font-size:.85rem; color:#777; }

    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.85);
      display:none; align-items:center; justify-content:center; padding:20px; z-index:9999;
    }
    .modal.open{ display:flex; }
    .modal img{
      max-width:95vw; max-height:95vh; border-radius:10px; border:1px solid #555; background:#000;
    }
    .modal-close{
      position:absolute; top:16px; right:18px; font-size:26px; color:#fff; cursor:pointer;
      user-select:none;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://raw.githubusercontent.com/qahastesfa-arch/ktinsight-reports/main/EOTC.png"
         alt="Ethiopian Orthodox Church Logo" class="logo">
    <h1>Incident Tracker for the Ethiopian Orthodox Tewahedo Church</h1>
  </header>

  <main>
    <p class="intro">
      This page is part of an incident-tracking database created by concerned supporters and worshipers of the
      Ethiopian Orthodox Tewahedo Church (EOTC). It documents reports of violence, persecution, or
      vandalism directed against the Ethiopian Orthodox Church, its worshipers, clergy, and church property.
      <br><br>
      Any links included in a report can be clicked. Evidence files open through secure, time-limited links.
    </p>

    <div class="video-feature">
      <iframe
        src="https://www.youtube.com/embed/xUjKXomeogI?si=jK1nmums7Hk4lnF3"
        title="YouTube video player"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        referrerpolicy="strict-origin-when-cross-origin"
        allowfullscreen>
      </iframe>
      <div class="video-caption">Featured testimony / documentation</div>
    </div>

    <div id="status" class="status">Loading latest reports…</div>
    <div id="list" class="list"></div>
  </main>

  <footer>
    © 2025 Ethiopian Orthodox Church Incident Reporting | KT Insight
  </footer>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-close" id="modalClose">✕</div>
    <img id="modalImg" src="" alt="Evidence full view">
  </div>

  <script>
    function escapeHtml(str){
      return String(str || '')
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function linkify(text){
      const safe = escapeHtml(text || "");
      return safe.replace(
        /(https?:\/\/[^\s<]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
      );
    }

    function looksLikeImage(key){
      if(!key) return false;
      const k = key.toLowerCase();
      return k.match(/\.(png|jpg|jpeg|gif|webp|bmp|svg)(\?.*)?$/);
    }

    function formatContact(raw){
      if(!raw) return "";
      let obj = null;
      try {
        obj = (typeof raw === "string") ? JSON.parse(raw) : raw;
      } catch(e){
        return escapeHtml(raw);
      }
      if(!obj || typeof obj !== "object") return "";
      const parts = [];
      if(obj.name) parts.push(`Name: ${escapeHtml(obj.name)}`);
      if(obj.phone) parts.push(`Phone: ${escapeHtml(obj.phone)}`);
      if(obj.reporting_country) parts.push(`Reporting From: ${escapeHtml(obj.reporting_country)}`);
      return parts.join(" | ");
    }

    async function loadIncidents(){
      const statusEl = document.getElementById('status');
      const listEl = document.getElementById('list');

      try{
        const resp = await fetch('/api/incidents');
        if(!resp.ok){
          const txt = await resp.text();
          console.error('API error', txt);
          statusEl.textContent = 'Failed to load reports from the server.';
          return;
        }

        const data = await resp.json();
        if(!Array.isArray(data) || data.length === 0){
          statusEl.textContent = 'No reviewed incident reports yet.';
          return;
        }

        statusEl.textContent = `Showing ${data.length} most recent reviewed report(s).`;

        const html = data.map((inc, idx) => {
          const reportedAt = inc.reported_at
            ? new Date(inc.reported_at).toLocaleString()
            : 'Unknown date';

          const region = escapeHtml(inc.region || 'Unknown location');
          const summaryHtml = linkify(inc.summary || '');
          const contactFormatted = formatContact(inc.contact);
          const evidenceRaw = inc.evidence_url || '';

          const evidenceKey = evidenceRaw.replace(/^evidence\//, '');
          const evidenceLink = evidenceKey
            ? `/api/evidence?key=${encodeURIComponent(evidenceKey)}`
            : '';

          const noteHtml = `
            <div class="evidence-note">
              If this evidence does not open or is unavailable, please contact the admin at
              <a href="mailto:sales@ktinsight.com">sales@ktinsight.com</a>.
            </div>
          `;

          const evidenceBlock = evidenceKey ? `
            <div class="evidence-wrap">
              <div class="evidence-label">Evidence</div>
              ${
                looksLikeImage(evidenceKey)
                  ? `
                    <img class="evidence-img"
                         src="${escapeHtml(evidenceLink)}"
                         alt="Evidence image"
                         data-full="${escapeHtml(evidenceLink)}">
                    <div class="evidence-link">
                      Open original:
                      <a href="${escapeHtml(evidenceLink)}" target="_blank" rel="noopener noreferrer">
                        Click to open full image
                      </a>
                    </div>
                    ${noteHtml}
                  `
                  : `
                    <div class="evidence-link">
                      Evidence file:
                      <a href="${escapeHtml(evidenceLink)}" target="_blank" rel="noopener noreferrer">
                        Click to open
                      </a>
                      <div style="margin-top:4px;font-size:0.8rem;color:#bdbdbd;">
                        ${escapeHtml(evidenceKey)}
                      </div>
                    </div>

                    <div class="evidence-help">Evidence not opening?</div>
                    ${noteHtml}
                  `
              }
            </div>
          ` : '';

          return `
            <article class="card">
              <div class="card-header">
                <div class="card-date">${reportedAt}</div>
                <div class="card-location">${region}</div>
              </div>

              <div class="card-summary summary-collapsed" id="summary-${idx}">
                ${summaryHtml}
              </div>
              <div class="see-more" data-target="summary-${idx}">See more</div>

              ${
                contactFormatted
                  ? `<div class="card-contact"><strong>Source/Contact:</strong> ${contactFormatted}</div>`
                  : ''
              }

              ${evidenceBlock}
            </article>
          `;
        }).join('');

        listEl.innerHTML = html;

        // ✅ Enable/hide "See more" only when needed + toggle
        requestAnimationFrame(() => {
          listEl.querySelectorAll('.see-more').forEach(btn => {
            const id = btn.getAttribute('data-target');
            const summary = document.getElementById(id);
            if(!summary) return;

            // If clamped height is smaller than full content → show button
            const isOverflowing = summary.scrollHeight > summary.clientHeight + 2;
            if(isOverflowing){
              btn.style.display = 'inline-block';
            }

            btn.addEventListener('click', () => {
              const collapsed = summary.classList.toggle('summary-collapsed');
              btn.textContent = collapsed ? 'See more' : 'See less';
            });
          });
        });

        // Modal + auto-failure note for images
        const modal = document.getElementById('modal');
        const modalImg = document.getElementById('modalImg');
        const modalClose = document.getElementById('modalClose');

        listEl.querySelectorAll('.evidence-img').forEach(img => {
          const wrap = img.closest('.evidence-wrap');
          const note = wrap ? wrap.querySelector('.evidence-note') : null;

          img.addEventListener('error', () => {
            if(note) note.classList.add('show');
          });

          img.addEventListener('click', () => {
            modalImg.src = img.getAttribute('data-full');
            modal.classList.add('open');
            modal.setAttribute('aria-hidden','false');
          });
        });

        function closeModal(){
          modal.classList.remove('open');
          modal.setAttribute('aria-hidden','true');
          modalImg.src = '';
        }

        modalClose.addEventListener('click', closeModal);
        modal.addEventListener('click', (e)=> {
          if(e.target === modal) closeModal();
        });
        document.addEventListener('keydown', (e)=> {
          if(e.key === 'Escape') closeModal();
        });

        // Non-image evidence: show note only if user clicks help
        listEl.querySelectorAll('.evidence-help').forEach(btn => {
          const wrap = btn.closest('.evidence-wrap');
          const note = wrap ? wrap.querySelector('.evidence-note') : null;
          btn.addEventListener('click', () => {
            if(note) note.classList.add('show');
          });
        });

      } catch(err){
        console.error(err);
        statusEl.textContent = 'An unexpected error occurred while loading reports.';
      }
    }

    document.addEventListener('DOMContentLoaded', loadIncidents);
  </script>
</body>
</html>
