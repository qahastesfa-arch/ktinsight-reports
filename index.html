<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ethiopian Orthodox Church Incident Reporting</title>

  <!-- Ethiopic-friendly fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#1a1a1a; --panel:#2b2b2b; --text:#f5f5f5; --muted:#e0e0e0;
      --gold:#f0d68a; --red:#8c1111; --red-2:#b11b1b; --stroke:#555;
    }
    * { box-sizing: border-box; }
    body {
      font-family: Inter, "Noto Sans Ethiopic", Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
    }
    header {
      text-align: center;
      background: linear-gradient(180deg, #4b0000 0%, #2a0000 100%);
      color: var(--text);
      padding: 24px 16px;
      border-bottom: 2px solid var(--red);
      position: sticky; top: 0; z-index: 5;
    }
    .topbar {
      display: flex; gap: 12px; align-items: center; justify-content: center; margin-bottom: 8px;
    }
    .lang-select {
      background: #220000; color: #fff; border: 1px solid #4a0d0d;
      border-radius: 6px; padding: 6px 10px; font-size: 0.95rem;
    }
    img.logo {
      max-width: 240px; height: auto; margin: 6px 0 10px;
      filter: grayscale(20%) contrast(120%);
    }
    h1, h2 { text-align: center; color: var(--gold); margin: 6px 0 0; }

    main {
      max-width: 680px; margin: 40px auto; background: var(--panel); padding: 28px;
      border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    p { line-height: 1.6; color: var(--muted); }
    form label { display:block; margin-top:15px; font-weight: 600; color: var(--gold); }
    input, textarea, select {
      width:100%; padding:10px; margin-top:6px; border-radius:6px; border:1px solid var(--stroke);
      background:#1e1e1e; color:var(--text); font-size:1rem;
    }
    input:focus, textarea:focus { outline:2px solid var(--red); background:#262626; }
    button {
      background: var(--red); color:#fff; border:none; padding:12px 20px; font-size:1rem;
      border-radius:8px; margin-top:22px; cursor:pointer; width:100%;
    }
    button:hover { background: var(--red-2); }
    button:disabled { opacity: 0.7; cursor: not-allowed; }

    .helper { font-size: 0.9rem; color:#bbb; margin-top: 8px; }
    footer { text-align:center; margin:50px 0 20px; font-size:0.9rem; color:#999; }

    .status-msg{
      margin-top:14px; padding:10px; border-radius:8px; display:none;
      background:#1e1e1e; border:1px solid #444; color:#eee;
      font-size:0.95rem; text-align:center;
    }
    .status-msg.show{ display:block; }

    /* =========================
       PASSWORD LOGIN GATE STYLE
       ========================= */
    #login-gate {
      position: fixed; inset: 0; background: white; z-index: 9999;
      display: grid; place-items: center; padding: 24px; font-family: sans-serif;
    }
    #login-form {
      width: 360px; max-width: 90vw; border: 1px solid #ddd;
      border-radius: 12px; padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }
    #login-form h2 { margin: 0 0 8px; color:#111; text-align:left; }
    #login-form p  { margin: 0 0 12px; color:#444; text-align:left; }
    #login-password {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;
      margin-bottom: 8px; font-size: 14px;
    }
    #login-error { color: crimson; margin-bottom: 8px; display:none; }
    #login-submit {
      width: 100%; padding: 10px; border-radius: 8px; border: none;
      cursor: pointer; font-size: 15px; font-weight: 600;
      background:#111; color:#fff;
    }
    #login-submit:hover { opacity: 0.9; }
  </style>
</head>

<body>

  <!-- =========================
       PASSWORD LOGIN GATE START
       ========================= -->
  <div id="login-gate">
    <form id="login-form">
      <h2>KT Insight Reports</h2>
      <p>Enter the shared password to continue.</p>

      <input id="login-password" type="password" placeholder="Password"/>

      <div id="login-error"></div>

      <button id="login-submit" type="submit">Unlock</button>

      <p style="margin:12px 0 0; font-size: 12px; color:#777; text-align:center;">
        Contact admin if you need access.
      </p>
    </form>
  </div>

  <script>
  (async function () {
    const gate = document.getElementById("login-gate");
    const form = document.getElementById("login-form");
    const input = document.getElementById("login-password");
    const err  = document.getElementById("login-error");

    // 1) Check session cookie via server
    try {
      const r = await fetch("/api/session");
      const j = await r.json();
      if (j.ok) {
        gate.style.display = "none";
        return;
      }
    } catch (e) {
      // ignore; user will log in
    }

    // 2) Handle password submit
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      err.style.display = "none";

      const password = input.value.trim();
      if (!password) return;

      try {
        const r = await fetch("/api/auth", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password })
        });

        if (r.ok) {
          gate.style.display = "none";
        } else {
          err.textContent = "Incorrect password.";
          err.style.display = "block";
        }
      } catch (e) {
        err.textContent = "Login failed. Try again.";
        err.style.display = "block";
      }
    });
  })();
  </script>
  <!-- =======================
       PASSWORD LOGIN GATE END
       ======================= -->


  <!-- =========================
       MAIN REPORTING PAGE
       ========================= -->
  <header>
    <div class="topbar">
      <label for="lang" style="font-weight:600;">üåê</label>
      <select id="lang" class="lang-select" aria-label="Language">
        <option value="en">English</option>
        <option value="am">·ä†·àõ·à≠·äõ</option>
      </select>
    </div>

    <img src="https://raw.githubusercontent.com/qahastesfa-arch/ktinsight-reports/main/EOTC.png"
         alt="Ethiopian Orthodox Church Logo" class="logo">
    <h1 data-i18n="title">Report Violence Against the Ethiopian Orthodox Church</h1>
  </header>

  <main>
    <h2 data-i18n="subtitle">Incident Reporting Portal</h2>
    <p data-i18n="intro">
      This site collects reports of violence, persecution, or vandalism directed against Ethiopian Orthodox
      Church worshippers, priests, and church property. Please provide as much detail as possible.
    </p>

    <form id="report-form" method="post" action="#">
      <label><span data-i18n="date_label">Date of Incident</span>:
        <input type="date" name="incident_date" required>
      </label>

      <label><span data-i18n="location_label">Location (City/Region)</span>:
        <input type="text" name="location" required data-ph="location_ph" placeholder="e.g. Gondar, Amhara">
      </label>

      <label><span data-i18n="reporting_country_label">Country You Are Reporting From</span>:
        <input type="text" name="reporting_country" required data-ph="country_ph" placeholder="e.g. United States, Ethiopia">
      </label>

      <!-- OPTIONAL -->
      <label><span data-i18n="name_label">Your Full Name (optional)</span>:
        <input type="text" name="reporter_name" data-ph="name_ph" placeholder="Full name">
      </label>

      <!-- OPTIONAL -->
      <label><span data-i18n="phone_label">Phone Number (optional)</span>:
        <input type="tel" name="phone" data-ph="phone_ph" placeholder="Include country code (e.g. +251...)">
      </label>

      <label><span data-i18n="details_label">Detailed Account of the Incident</span>:
        <textarea name="details" rows="6" required data-ph="details_ph"
          placeholder="Describe what happened, when, where, and who was involved‚Ä¶"></textarea>
      </label>

      <!-- OPTIONAL FILE -->
      <label><span data-i18n="evidence_label">Upload Photo or Evidence (optional)</span>:
        <input type="file" name="evidence" accept="image/*,application/pdf">
      </label>

      <div class="helper" data-i18n="privacy_note">
        Providing your name, phone number, and any photo or evidence is optional. You may leave these fields blank if you feel unsafe.
      </div>

      <button type="submit" id="submitBtn" data-i18n="submit_btn">Submit Report</button>
      <div id="statusMsg" class="status-msg"></div>
    </form>
  </main>

  <footer>
    ¬© 2025 <span data-i18n="footer_org">Ethiopian Orthodox Church Incident Reporting</span> | ktinsight.com
  </footer>


  <script>
    // ------- i18n dictionary -------
    const t = {
      en: {
        title: "Report Violence Against the Ethiopian Orthodox Church",
        subtitle: "Incident Reporting Portal",
        intro: "This site collects reports of violence, persecution, or vandalism directed against Ethiopian Orthodox Church worshippers, priests, and church property. Please provide as much detail as possible.",
        date_label: "Date of Incident",
        location_label: "Location (City/Region)",
        reporting_country_label: "Country You Are Reporting From",
        name_label: "Your Full Name (optional)",
        phone_label: "Phone Number (optional)",
        details_label: "Detailed Account of the Incident",
        evidence_label: "Upload Photo or Evidence (optional)",
        privacy_note: "Providing your name, phone number, and any photo or evidence is optional. You may leave these fields blank if you feel unsafe.",
        submit_btn: "Submit Report",
        footer_org: "Ethiopian Orthodox Church Incident Reporting",
        location_ph: "e.g. Gondar, Amhara",
        country_ph: "e.g. United States, Ethiopia",
        name_ph: "Full name",
        phone_ph: "Include country code (e.g. +251...)",
        details_ph: "Describe what happened, when, where, and who was involved‚Ä¶"
      },
      am: {
        title: "·â†·ä¢·âµ·ãÆ·åµ·ã´ ·ä¶·à≠·â∂·ã∂·ä≠·àµ ·â∞·ãã·àÖ·ã∂ ·â§·â∞·ä≠·à≠·àµ·â≤·ã´·äï ·àã·ã≠ ·ã®·â∞·çà·å†·à® ·å•·âÉ·âµ ·à™·çñ·à≠·âµ ·ã´·âÄ·à≠·â°",
        subtitle: "·ã®·ä≠·àµ·â∞·âµ ·à™·çñ·à≠·âµ ·àò·ãµ·à®·ä≠",
        intro: "·ã≠·àÖ ·åà·åΩ ·â†·ä¢·âµ·ãÆ·åµ·ã´ ·ä¶·à≠·â∂·ã∂·ä≠·àµ ·â§·â∞·ä≠·à≠·àµ·â≤·ã´·äï ·ãà·ã≠·àù ·â†·ä†·àò·äï·â≥·ãä·ãé·âΩ·ç£ ·â†·ä´·àÖ·äì·âµ ·ä•·äì ·â†·â§·â∞·ä≠·à≠·àµ·â≤·ã´·äï ·äï·â•·à®·âµ ·àã·ã≠ ·ã®·àö·çà·å†·à© ·å•·âÉ·â∂·âΩ·äï ·àà·àõ·àµ·âÄ·àò·å• ·ã≠·å†·âÖ·àõ·àç·ç¢",
        date_label: "·ã®·ä≠·àµ·â∞·â± ·âÄ·äï",
        location_label: "·â¶·â≥ (·ä®·â∞·àõ/·ä≠·àç·àç)",
        reporting_country_label: "·ä®·ã®·âµ ·ä†·åà·à≠ ·ä•·ã®·åà·àà·çÅ ·äê·ãç?",
        name_label: "·àô·àâ ·àµ·àù·ãé (·ä†·àõ·à´·å≠)",
        phone_label: "·àµ·àç·ä≠ ·âÅ·å•·à≠ (·ä†·àõ·à´·å≠)",
        details_label: "·ã®·ä≠·àµ·â∞·â± ·ãù·à≠·ãù·à≠ ·àò·åç·àà·å´",
        evidence_label: "·çé·â∂ ·ãà·ã≠·àù ·àõ·àµ·à®·åÉ ·àõ·àµ·åà·â¢·ã´ (·ä†·àõ·à´·å≠)",
        privacy_note: "·àµ·àù·ãé·äï·ç£ ·àµ·àç·ä≠ ·âÅ·å•·à≠·ãé·äï ·ãà·ã≠·àù ·çé·â∂/·àõ·àµ·à®·åÉ ·àò·àµ·å†·âµ ·ä†·àõ·à´·å≠ ·äê·ãç·ç¢",
        submit_btn: "·à™·çñ·à≠·âµ ·ã´·àµ·åà·â°",
        footer_org: "·ã®·ä¢.·ä¶.·â∞. ·ã®·ä≠·àµ·â∞·âµ ·à™·çñ·à≠·âµ ·àò·ãµ·à®·ä≠",
        location_ph: "·àà·àù·à≥·àå·ç° ·åé·äï·ã∞·à≠·ç£ ·ä†·àõ·à´",
        country_ph: "·àà·àù·à≥·àå·ç° ·ä¢·âµ·ãÆ·åµ·ã´·ç£ ·ä†·àú·à™·ä´",
        name_ph: "·àô·àâ ·àµ·àù",
        phone_ph: "·ã®·ä†·åà·à≠ ·äÆ·ãµ ·ã´·ä´·âµ·â± (·àà·àù·à≥·àå +251...)",
        details_ph: "·àù·äï ·â∞·ä®·à∞·â∞·ç£ ·àò·âº·ç£ ·ã®·âµ ·ä•·äì ·àõ·äï ·â∞·ä´·â∞·â± ·â†·ãù·à≠·ãù·à≠ ·ã≠·åç·àà·åπ‚Ä¶"
      }
    };

    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const langSel = $('#lang');

    function applyLang(lang){
      document.documentElement.lang = (lang === 'am' ? 'am' : 'en');
      $$('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        el.textContent = t[lang][key] || t.en[key] || '';
      });
      $$('[data-ph]').forEach(el=>{
        const key = el.getAttribute('data-ph');
        el.placeholder = t[lang][key] || t.en[key] || '';
      });
    }

    const saved = localStorage.getItem('kt_lang') || 'en';
    langSel.value = saved;
    applyLang(saved);
    langSel.addEventListener('change', ()=>{
      localStorage.setItem('kt_lang', langSel.value);
      applyLang(langSel.value);
    });

    // ------- Correct direct upload -------
    async function uploadDirectToSupabase(file) {
      const name = (file.name || "").toLowerCase();
      const ext = name.includes(".") ? name.split(".").pop() : "bin";

      const signResp = await fetch("/api/sign-upload", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ ext })
      });

      const signJson = await signResp.json();
      if (!signResp.ok || !signJson.ok) {
        throw new Error("Sign-upload failed: " + JSON.stringify(signJson));
      }

      let uploadUrl = signJson.signedUploadUrl || "";
      const token = signJson.token || null;

      // If token is separate AND URL doesn't already have one, append.
      if (token && !uploadUrl.includes("token=")) {
        uploadUrl += (uploadUrl.includes("?") ? "&" : "?") +
          "token=" + encodeURIComponent(token);
      }

      if (!uploadUrl.includes("token=")) {
        throw new Error("Signed upload URL missing token.");
      }

      const putResp = await fetch(uploadUrl, {
        method: "PUT",
        headers: {
          "Content-Type": file.type || "application/octet-stream",
          "x-upsert": "true"
        },
        body: file
      });

      if (!putResp.ok) {
        const txt = await putResp.text();
        throw new Error("Evidence upload failed: " + txt);
      }

      return signJson.key;
    }

    // ------- Form submit (JSON only) -------
    const formEl = $('#report-form');
    const statusMsg = $('#statusMsg');
    const submitBtn = $('#submitBtn');

    function showStatus(msg, ok=true){
      statusMsg.textContent = msg;
      statusMsg.style.borderColor = ok ? "#2d6a2d" : "#7a2222";
      statusMsg.style.background = ok ? "#102010" : "#2a1010";
      statusMsg.classList.add("show");
    }

    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusMsg.classList.remove("show");

      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting...";

      try {
        const fd = new FormData(formEl);
        const file = fd.get("evidence");
        let evidence_key = null;

        if (file && file.size > 0) {
          evidence_key = await uploadDirectToSupabase(file);
        }

        const payload = {
          incident_date: fd.get("incident_date"),
          location: fd.get("location"),
          reporting_country: fd.get("reporting_country"),
          reporter_name: fd.get("reporter_name"),
          phone: fd.get("phone"),
          details: fd.get("details"),
          evidence_key
        };

        const r = await fetch("/api/report", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        const j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error || "Report failed.");

        showStatus("Submitted! Your report will appear after admin approval.", true);
        formEl.reset();

      } catch (err) {
        console.error(err);
        showStatus("Submission failed: " + err.message, false);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent =
          t[langSel.value]?.submit_btn || "Submit Report";
      }
    });
  </script>
</body>
</html>
